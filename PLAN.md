# План разработки Neetrino Platform

## Общее описание проекта

Создание нового сайта "по коду" (не WordPress) для каталога демо-версий с функционалом, похожим на neetrino.com, но с уникальным дизайном и контентом. Платформа для автоматического сбора, управления и проверки доступности демо-версий от крупных вендоров.

## Ключевые принципы

- ❌ **Никаких таймеров и "деревенских" маркетинговых трюков**
- ✅ **Масштабируемость:** 50,000+ демо с перспективой до 100,000+
- ✅ **Нейтральный UI:** тема на токенах (`--color-primary`, `--radius`, `--font-sans`)
- ✅ **Похожесть — по структуре**, а не по внешнему виду neetrino.com
- ✅ **Этика импорта:** уважение robots.txt, лимиты параллельности, паузы между запросами
- ✅ **Локаль:** Asia/Yerevan по умолчанию
- ✅ **Автоматизация процессов** с минимальным ручным вмешательством

## Технологический стек и архитектура

### Рекомендуемый стек
- **Frontend:** Next.js 14 (App Router, ISR/SSG), Tailwind CSS, shadcn/ui, i18n (RU/AM/EN)
- **Backend API:** NestJS (TypeScript) с модульной архитектурой
- **База данных:** PostgreSQL с оптимизированными индексами
- **Очереди/планирование:** Redis + BullMQ для фоновых задач
- **Поиск (опционально):** Meilisearch для быстрого поиска
- **Медиа-хранилище:** S3/R2 + CDN для изображений
- **Аутентификация:** Auth.js/Clerk с RBAC системой
- **Мониторинг:** Sentry (web/api/jobs), Bull Board (очереди)

### Монорепо структура
```
apps/
├── web/          # Next.js приложение
├── api/          # NestJS API
├── jobs/         # Фоновые задачи (импорт, проверки)
packages/
├── ui/           # Общие UI компоненты
├── types/        # TypeScript типы
├── utils/        # Утилиты
└── config/       # Конфигурации
```

## Детальная архитектура системы

### Сущности и модель данных

#### Vendor (Вендор)
```typescript
interface Vendor {
  id: string;
  name: string;
  base_url: string;
  is_active: boolean;
  connector: {
    mode: 'CSS' | 'API' | 'Sitemap';
    params: ConnectorParams;
  };
  limits: {
    concurrency: number;    // ≤3 на домен
    delayMs: number;        // 500-1500ms
    userAgent: string;
  };
  created_at: Date;
}
```

#### Demo (Демо)
```typescript
interface Demo {
  id: string;
  vendor_id: string;
  theme_id?: string;
  name?: string;
  url: string;              // оригинальный URL
  url_canonical: string;    // нормализованный ключ
  state: 'active' | 'draft' | 'deleted';
  first_seen_at: Date;
  last_seen_at: Date;
  first_failed_at?: Date;
  last_ok_at?: Date;
  media_set?: MediaSet;
}
```

#### ImportRun (Запуск импорта)
```typescript
interface ImportRun {
  id: string;
  vendor_id: string;
  started_at: Date;
  finished_at?: Date;
  totals: {
    found: number;
    new: number;
    ignored: number;
    errors: number;
  };
  log: string;
}
```

#### CheckRun (Проверка доступности)
```typescript
interface CheckRun {
  id: string;
  demo_id: string;
  started_at: Date;
  finished_at: Date;
  result: {
    status: number;
    timeout?: boolean;
    error?: string;
  };
  ok: boolean;
  note?: string;
}
```

### Нормализация URL
- Приведение к HTTPS
- Удаление UTM/gclid/fbclid параметров
- Удаление якорей (#)
- Удаление завершающего слеша
- Приведение хоста к нижнему регистру

## Этапы разработки (Спринты)

### Спринт 1: Каркас и аутентификация (2-3 недели)
- [ ] Настройка монорепо с Turborepo
- [ ] Конфигурация окружений (dev/staging/prod)
- [ ] Система аутентификации с RBAC
- [ ] Базовые страницы публичной части
- [ ] **DoD:** вход в админку работает, роли ограничивают доступ

### Спринт 2: Модель данных и CRUD (2-3 недели)
- [ ] Создание сущностей Vendor/Theme/Demo/ImportRun/CheckRun
- [ ] Настройка миграций PostgreSQL
- [ ] CRUD операции в админке
- [ ] Базовые индексы для производительности
- [ ] **DoD:** можно руками завести данные, индексы настроены

### Спринт 3: Система импорта и DIFF (3-4 недели)
- [ ] Коннекторы CSS/API/Sitemap (минимум один рабочий)
- [ ] Нормализация URL и сравнение с БД
- [ ] DIFF-интерфейс в админке
- [ ] Массовое добавление выбранных демо
- [ ] **DoD:** из внешнего источника добавляются новые демо

### Спринт 4: Публичная витрина (3-4 недели)
- [ ] Каталог с фильтрами и поиском
- [ ] PDP демо с iframe + fallback
- [ ] Viewer для изолированного просмотра
- [ ] Переключатели ширины (375/768/1280)
- [ ] **DoD:** демо корректно открываются, UX соответствует требованиям

### Спринт 5: Система проверки доступности (2-3 недели)
- [ ] Планировщик и очереди проверок
- [ ] Переходы статусов: active → draft → deleted
- [ ] Журнал проверок в админке
- [ ] Автоматическое удаление через 30 дней
- [ ] **DoD:** draft при первом фейле, удаление после 30 дней

### Спринт 6: Медиа-пайплайн (опционально, 2-3 недели)
- [ ] Python-скрипт для генерации скриншотов
- [ ] Интеграция с основной системой
- [ ] Хранение в S3/R2 + CDN
- [ ] Fallback при недоступности демо
- [ ] **DoD:** карточки с постерами, fallback работает

### Спринт 7: SEO, аналитика и мониторинг (2-3 недели)
- [ ] Sitemap, OG-теги, JSON-LD
- [ ] События аналитики (catalog_view, demo_open, etc.)
- [ ] Sentry для отслеживания ошибок
- [ ] Отчёты в админке
- [ ] **DoD:** метрики в норме, отчёты доступны

### Спринт 8: Полировка и релиз (2-3 недели)
- [ ] Локализация RU/AM/EN
- [ ] Перформанс-аудит (LCP ≤ 2.5s)
- [ ] Доступность (WCAG)
- [ ] Финальные политики и документация
- [ ] **DoD:** готово к продакшену

## Публичная часть сайта

### Страницы и функционал
- **/** Главная: УТП, "Выбрать дизайн", подборки по нишам, "Как это работает" (4 шага), мини-FAQ, форма лида
- **/catalog** Каталог: фильтры (вендор/категории/теги), поиск, сортировки; карточки демо (бренд/название/постер/статус/кнопки)
- **/vendors** Список брендов; **/vendors/[slug]** — страница бренда с его демо и фильтрами
- **/demo/[id|slug]** PDP демо: iframe (если разрешено) или постер/скрины; переключатели ширины 375/768/1280; кнопка "Открыть во вкладке"
- **/viewer?u=...** Viewer: изолированный просмотр внешнего URL, копирование ссылки, fallback при запрете iframe
- **/privacy**, **/terms** — шаблоны для политики/условий

### UX-требования
- Мгновенный fallback на постер при недоступности iframe
- Отсутствие навязчивых оверлеев
- Понятные CTA кнопки
- Адаптивный дизайн для всех устройств

## Админ-панель: разделы и функционал

### 1. Вендоры
- **Поля:** Название, Базовый домен, Тип коннектора (CSS/API/Sitemap)
- **Параметры:** стартовые URL, селекторы/паттерны, заголовки API
- **Лимиты:** параллельность (≤3), пауза (500-1500ms), user-agent
- **Действия:** Сохранить, Деактивировать, Экспорт/Импорт конфигурации

### 2. Импорт
- Выпадающий список "Вендор", кнопка "Сканировать"
- После скана: таблица DIFF (**Бренд | Название | URL**), чекбоксы, "Выбрать всё", "Добавить на сайт"
- Боковая панель: статистика ImportRun (found/new/ignored/errors), дата/время

### 3. Демо
- Таблица: бренд, название, URL, state, first_seen_at, last_seen_at, last_ok_at, first_failed_at
- Фильтры: бренд, state, период дат; поиск по названию/URL
- Действия: "В актив", "В черновик", "Удалить навсегда", "Перепроверить" (bulk)

### 4. Checking (Проверки доступности)
- Глобальные настройки интервала (дни/часы/минуты)
- Override на уровне вендора/демо
- История проверок: последние N записей (дата, результат, заметка)
- Тумблер "включить/выключить проверки" (для отладки)

### 5. Пользователи/Роли
- **Роли:** Owner (всё), Admin (контент/импорт/проверки), Editor (контент без критических операций)
- Список пользователей, роли, статус активности
- Аудит-лог: кто/когда/что делал (импорт, добавление, удаление, смена статуса)

## Система импорта: коннекторы и DIFF

### Типы коннекторов
- **CSS:** страницы каталога + CSS-селекторы карточек/ссылок/названий; пагинация
- **API:** JSON-эндпоинт вендора (ключ/заголовки)
- **Sitemap:** URL карты сайта + паттерны фильтрации

### Процесс импорта
1. Сканер получает сырые URL демо для выбранного Vendor
2. Выполняется нормализация → получаем `url_canonical`
3. Сравнение с БД → формируется **DIFF**: "чего у нас нет"
4. Сохраняется **ImportRun** (история; статистика)
5. Админ видит таблицу **DIFF** (**Бренд | Название | URL**), ставит галочки и жмёт "Добавить"

### Контроль нагрузки и этика
- Пауза между запросами (500–1500 мс)
- Ограничение параллельности (≤3 на домен)
- User-agent, уважение robots.txt
- Ретраи с бэкоффом, логирование ошибок

## Система проверки доступности (Checking)

### Цель
Убедиться, что **наши демо** доступны пользователям.

### MVP-уровень проверки
- **HTTP-проверка** URL (код ответа, разумные редиректы, тайм-аут)
- Без тяжёлого рендера (опционально позже)

### Расписание
- Глобальный интервал (например, раз в 7 дней) + override на уровне Vendor/Demo
- Равномерное распределение задач (чтобы не было пиков)

### Статусы и переходы
- Успешно → `state = active`, `last_ok_at = now()`
- Первая ошибка/тайм-аут → `state = draft`, если пусто — `first_failed_at = now()`
- Если прошло **30 дней** с `first_failed_at` и **ни одной** успешной проверки не было → `state = deleted` (**удаление навсегда**)
- Ручной оверрайд в админке допускается (восстановление, продление, немедленное удаление)

### Журнал
Краткие записи в **CheckRun** (дата, результат, заметка), хранить N последних.

## API эндпоинты

### Auth & Users
- `POST /auth/login` — вход
- `POST /auth/logout` — выход
- `GET /users/me` — профиль и роли
- `GET /users` / `POST /users` / `PATCH /users/:id` — управление пользователями
- `GET /audit` — аудит-лог действий

### Vendors
- `GET /vendors` — список (фильтры, пагинация)
- `POST /vendors` — создать
- `GET /vendors/:id` — получить
- `PATCH /vendors/:id` — обновить (включая connector/limits)
- `DELETE /vendors/:id` — удалить/деактивировать

### Demos
- `GET /demos` — список (фильтры по vendor/theme/state/q)
- `POST /demos` — создать (ручное добавление)
- `GET /demos/:id` — получить
- `PATCH /demos/:id` — обновить (state/поля/override интервалов)
- `DELETE /demos/:id` — удалить (мягко/жёстко)
- `POST /demos/bulk` — массовые операции (activate/draft/delete/recheck)

### Import
- `POST /import/runs` — запустить сканирование для vendor
- `GET /import/runs` — журнал импортов
- `GET /import/runs/:id` — детали (статистика, лог)
- `GET /import/diff?vendorId=...` — получить DIFF (Brand/Name/URL)
- `POST /import/confirm` — добавить выбранные позиции из DIFF

### Checking
- `GET /checking/settings` / `PATCH /checking/settings` — глобальные интервалы
- `PATCH /checking/vendors/:id` — override интервала
- `PATCH /checking/demos/:id` — override интервала
- `POST /checking/runs` — ручной запуск проверок
- `GET /checking/runs` — журнал проверок
- `GET /checking/runs/:id` — детали по демо

### Public (web)
- `GET /public/catalog` — список демо (фильтры, пагинация)
- `GET /public/demo/:slug` — карточка демо (данные для PDP)
- `GET /public/vendors` / `GET /public/vendors/:slug` — бренды и их демо

## Медиа-пайплайн (опционально)

### Что генерируем
- `lcp`-постер + 2–3 скрина (375/768/1280) для карточек/PDP
- Опционально короткое превью-видео

### Где храним
- S3/R2 + CDN
- Ключ — хэш URL + дата билда

### Когда обновлять
- При первом добавлении
- Далее — по TTL/по кнопке "обновить"
- При явных изменениях демо

### Fallback
Если демо недоступно — используем последний удачный постер/скрины.

## SEO, доступность и производительность

### SEO
- Sitemap, canonical, JSON-LD (SoftwareApplication/Product)
- OG-картинки из постера, чистые URL

### Доступность
- aria-метки, фокус-кольца, контраст
- Навигация с клавиатуры

### Перформанс-бюджеты (минимум)
- LCP ≤ 2.5 s на каталоге и PDP (десктоп/мобайл)
- TTI ≤ 4 s; CLS < 0.1; TBT < 300 ms
- Изображения AVIF/WebP; lazy-loading; кеш браузера/CDN; ISR/SSG

## Безопасность и аудит

### Безопасность
- Строгий CSP; sandbox для iframe
- Валидация входных данных
- Rate-limit на импорт/проверки
- Защита от XSS/CSRF

### Аудит-лог
Кто/когда: запускал импорт, добавлял демо, менял статусы, удалял.

## Аналитика и мониторинг

### События (frontend)
- `catalog_view`, `filter_change`, `search_submit`
- `demo_open`, `viewer_open`, `lead_submit`

### Ошибки
- Sentry (web/api/jobs)

### Очереди
- Bull Board (активные/завершённые/ретраи, длительность, тайм-ауты)

### Отчёты в админке
По импортам (сколько найдено/новых/ошибок) и проверкам (сколько active/draft/deleted).

## Тестирование

### Unit тесты
- Нормализация URL → корректный `url_canonical`
- Правила статусов: active → (фейл) → draft → (30 дней без успехов) → deleted

### Integration тесты
- Импорт DIFF: фиктивный список URL → таблица "чего нет у нас" корректна
- Bulk-добавление демо → появляются в каталоге с нужными полями

### E2E тесты (админ)
- Завести Vendor → Сканировать → Выбрать DIFF → Добавить → Проверить в каталоге
- Имитировать недоступность URL → статус draft; симулировать "+30 дней" → deleted

### Accessibility тесты
- Навигация клавиатурой, фокус-кольца, aria-атрибуты, контраст

## CI/CD и окружения

### Окружения
- **Staging/Prod** с одинаковыми сервисами (web/api/db/redis/(meilisearch)/(s3 proxy))

### Пайплайн
- Линт/тесты/миграции → сборка → деплой на staging → ручной promote в production

### Секреты
- Менеджер секретов; никаких ключей в репозитории

### Бэкапы БД
- Ежедневные + еженедельные; регламент восстановления

## Нефункциональные требования и SLA

### Производительность
- LCP ≤ 2.5 s; TTI ≤ 4 s; CLS < 0.1; TBT < 300 ms

### Доступность
- WCAG-ориентированный базовый набор (фокус-кольца, aria-лейблы, контраст)

### Надёжность
- 99.9% доступности публичной части; очереди устойчивы к рестартам

### Бэкапы
- RPO ≤ 24 ч; RTO ≤ 4 ч

### Безопасность
- CSP, XSS/CSRF защита, rate-limits, аудит-лог

## Возможные риски и решения

### Риск: Медленная работа с большим количеством демо
**Решение**: Кэширование, пагинация, оптимизация запросов, индексы БД

### Риск: Нестабильность парсинга внешних сайтов
**Решение**: Обработка ошибок, повторные попытки, логирование, fallback стратегии

### Риск: Высокая нагрузка на сервер при проверке доступности
**Решение**: Очереди задач, распределение нагрузки по времени, rate limiting

### Риск: Изменения в структуре сайтов вендоров
**Решение**: Гибкие коннекторы, мониторинг изменений, быстрое обновление селекторов

## Временные рамки

**Общее время разработки**: 16-24 недели (4-6 месяцев)

- **Спринт 1-2**: 4-6 недель (каркас + модель данных)
- **Спринт 3-4**: 6-8 недель (импорт + публичная часть)
- **Спринт 5-6**: 4-6 недель (проверки + медиа)
- **Спринт 7-8**: 4-6 недель (полировка + релиз)

## Следующие шаги

1. **Утверждение плана** и технического стека
2. **Настройка монорепо** с Turborepo
3. **Создание базовой структуры** проекта
4. **Настройка CI/CD** и окружений
5. **Начало разработки** с первого спринта
