# Проект: Новый сайт‑каталог демо (без WordPress) — ТЗ и подробный план

> **Цель:** собрать сайт, похожий по **структуре и функционалу** на neetrino.com, но **без копирования дизайна/контента**, с масштабируемым **импортом демо** от крупных вендоров, удобной админкой, **авто‑черновиками** и **авто‑удалением** неработающих демо. Никаких «таймеров» и тёмных паттернов.

---

## Содержание
1. [Принципы и ограничения](#принципы-и-ограничения)
2. [Стек и архитектура](#стек-и-архитектура)
3. [Страницы публичной части](#страницы-публичной-части)
4. [Админ‑панель: разделы и флоу](#админ-панель-разделы-и-флоу)
5. [Сущности и данные (концептуально)](#сущности-и-данные-концептуально)
6. [Импорт: коннекторы и DIFF](#импорт-коннекторы-и-diff)
7. [Проверки доступности (Checking)](#проверки-доступности-checking)
8. [Публичная витрина: каталог, PDP, viewer](#публичная-витрина-каталог-pdp-viewer)
9. [Медиа‑пайплайн (опционально)](#медиа-пайплайн-опционально)
10. [SEO, доступность и перформанс‑бюджеты](#seo-доступность-и-перформанс-бюджеты)
11. [RBAC, безопасность и аудит](#rbac-безопасность-и-аудит)
12. [Аналитика и мониторинг](#аналитика-и-мониторинг)
13. [Тестирование: критерии и кейсы](#тестирование-критерии-и-кейсы)
14. [CI/CD и окружения](#cicd-и-окружения)
15. [Дорожная карта (спринты)](#дорожная-карта-спринты)
16. [API (перечень эндпоинтов)](#api-перечень-эндпоинтов)
17. [UX‑описание экранов админки](#ux-описание-экранов-админки)
18. [Нефункциональные требования и SLA](#нефункциональные-требования-и-sla)
19. [Топология деплоя](#топология-деплоя)
20. [Открытые вопросы и решения](#открытые-вопросы-и-решения)
21. [Шпаргалка для Cursor](#шпаргалка-для-cursor)

---

## Принципы и ограничения
- **Никаких таймеров/обратных отсчётов.** Честные триггеры (статусы, сроки, доступность).
- **Масштабируемость:** 50 000+ демо с перспективой до 100 000+.
- **Нейтральный UI:** тема на токенах (`--color-primary`, `--radius`, `--font-sans`); контент — плейсхолдеры.
- **Похожесть — по структуре**, а не по внешнему виду neetrino.com.
- **Этика импорта:** уважать robots.txt, лимиты параллельности, паузы между запросами.
- **Локаль:** Asia/Yerevan по умолчанию.

---

## Стек и архитектура
- **Frontend:** Next.js 14 (App Router, ISR/SSG), Tailwind, shadcn/ui, i18n (RU/AM/EN).
- **Backend API:** NestJS (TypeScript).
- **БД:** PostgreSQL.
- **Очереди/планирование:** Redis + BullMQ.
- **Поиск (опц.):** Meilisearch.
- **Медиа (опц.):** S3/R2 + CDN.
- **Аутентификация:** Auth.js/Clerk, RBAC.
- **Наблюдаемость:** Sentry (web/api/jobs), Bull Board (очереди).

**Монорепо:** `apps/web` (Next), `apps/api` (Nest), `jobs` (фоновые задачи), `packages/ui` (компоненты), `packages/types` (типы).

---

## Страницы публичной части
- **/** Главная: УТП, «Выбрать дизайн», подборки по нишам, «Как это работает» (4 шага), мини‑FAQ, форма лида.
- **/catalog** Каталог: фильтры (вендор/категории/теги), поиск, сортировки; карточки демо (бренд/название/постер/статус/кнопки).
- **/vendors** Список брендов; **/vendors/[slug]** — страница бренда с его демо и фильтрами.
- **/demo/[id|slug]** PDP демо: iframe (если разрешено) или постер/скрины; переключатели ширины 375/768/1280; кнопка «Открыть во вкладке».
- **/viewer?u=...** Viewer: изолированный просмотр внешнего URL, копирование ссылки, fallback при запрете iframe.
- **/privacy**, **/terms** — шаблоны для политики/условий.

**UX‑требования:** мгновенный fallback на постер, отсутствие навязчивых оверлеев, понятные CTA.

---

## Админ‑панель: разделы и флоу
1) **Вендоры**: CRUD; поля коннектора (тип: CSS/API/Sitemap; стартовые URL; селекторы/паттерны; заголовки; лимиты).
2) **Темы** (опц.): связаны с вендором; имя, slug, категории/теги.
3) **Демо**: список; фильтры (бренд/статус/даты); поля `name`, `url`, `url_canonical`, `state: active|draft|deleted`, `first_seen_at`, `last_seen_at`, `first_failed_at`, `last_ok_at`; bulk‑операции.
4) **Импорт**: выбор вендора → «Сканировать» → таблица **DIFF** (**Бренд | Название | URL**) с чекбоксами → «Добавить на сайт».
5) **Checking**: глобальный интервал проверок + override на уровне вендора/демо; журнал последних проверок; массовые действия.
6) **Пользователи/Роли**: Owner/Admin/Editor; аудит‑лог.
7) **Настройки**: SEO‑дефолты, OG, CSP‑домены, токены темы (цвет/шрифты/радиусы).

---

## Сущности и данные (концептуально)
- **Vendor**: id, name, base_url, is_active, connector{mode, params}, limits{concurrency, delayMs, userAgent}, created_at.
- **Theme** (опц.): id, vendor_id→Vendor, name, slug, category, tags[].
- **Demo**: id, vendor_id, theme_id?, name?, url (оригинал), **url_canonical** (нормализованный ключ), **state** (`active|draft|deleted`), first_seen_at, last_seen_at, first_failed_at?, last_ok_at?.
- **ImportRun**: id, vendor_id, started_at, finished_at, totals{found,new,ignored,errors}, log (краткий).
- **CheckRun**: id, demo_id, started_at, finished_at, result{status|timeout|error}, ok:bool, note.
- **MediaSet** (опц.): id, demo_id, lcp_url, shot_375_url, shot_768_url, shot_1280_url, created_at.

**Нормализация URL:** https; убрать UTM/gclid/fbclid и пр.; без `#`; без завершающего `/`; хост в нижнем регистре. Используется как ключ для DIFF и уникальности.

---

## Импорт: коннекторы и DIFF
**Типы коннекторов:**
- **CSS**: страницы каталога + CSS‑селекторы карточек/ссылок/названий; пагинация.
- **API**: JSON‑эндпоинт вендора (ключ/заголовки).
- **Sitemap**: URL карты сайта + паттерны фильтрации.

**Процесс импорта:**
1. Сканер получает сырые URL демо для выбранного Vendor.
2. Выполняется нормализация → получаем `url_canonical`.
3. Сравнение с БД → формируется **DIFF**: «чего у нас нет».
4. Сохраняется **ImportRun** (история; статистика).
5. Админ видит таблицу **DIFF** (**Бренд | Название | URL**), ставит галочки и жмёт «Добавить».

**Контроль нагрузки и этика:**
- Пауза между запросами (500–1500 мс), ограничение параллельности (≤3 на домен), user‑agent, уважение robots.txt.
- Ретраи с бэкоффом, логирование ошибок.

---

## Проверки доступности (Checking)
**Цель:** убедиться, что **наши демо** доступны пользователям.

**MVP‑уровень проверки:**
- **HTTP‑проверка** URL (код ответа, разумные редиректы, тайм‑аут).
- Без тяжёлого рендера (опционально позже).

**Расписание:**
- Глобальный интервал (например, раз в 7 дней) + override на уровне Vendor/Demo.
- Равномерное распределение задач (чтобы не было пиков).

**Статусы и переходы:**
- Успешно → `state = active`, `last_ok_at = now()`.
- Первая ошибка/тайм‑аут → `state = draft`, если пусто — `first_failed_at = now()`.
- Если прошло **30 дней** с `first_failed_at` и **ни одной** успешной проверки не было → `state = deleted` (**удаление навсегда**).
- Ручной оверрайд в админке допускается (восстановление, продление, немедленное удаление).

**Журнал:** краткие записи в **CheckRun** (дата, результат, заметка), хранить N последних.

---

## Публичная витрина: каталог, PDP, viewer
**Каталог:**
- Фильтры: вендор, категория/теги; поиск по названию/URL; сортировки (новые/популярные).
- Карточка: бренд, название (если есть), постер/скрин (если есть), бейдж статуса, кнопки «Смотреть»/«Открыть во вкладке».

**PDP демо:**
- Если разрешён iframe → встроить с `sandbox` (строгий allowlist).
- Иначе → показать последний скрин/постер + кнопку «Открыть во вкладке».
- Переключатели ширины (375/768/1280), без тёмных паттернов.

**Viewer:**
- Изолированный просмотр внешнего URL, копирование ссылки с параметрами; корректный fallback.

---

## Медиа‑пайплайн (опционально)
- **Что генерим:** `lcp`‑постер + 2–3 скрина (375/768/1280) для карточек/PDP; опционально короткое превью‑видео.
- **Где храним:** S3/R2 + CDN; ключ — хэш URL + дата билда.
- **Когда обновлять:** при первом добавлении; далее — по TTL/по кнопке «обновить»; при явных изменениях демо.
- **Fallback:** если демо недоступно — используем последний удачный постер/скрины.

---

## SEO, доступность и перформанс‑бюджеты
- **SEO:** Sitemap, canonical, JSON‑LD (SoftwareApplication/Product), OG‑картинки из постера, чистые URL.
- **Доступность:** aria‑метки, фокус‑кольца, контраст, навигация с клавиатуры.
- **Перформанс‑бюджеты (минимум):**
  - LCP ≤ 2.5 s на каталоге и PDP (десктоп/мобайл).
  - TTI ≤ 4 s; CLS < 0.1; TBT < 300 ms.
  - Изображения AVIF/WebP; lazy‑loading; кеш браузера/CDN; ISR/SSG.

---

## RBAC, безопасность и аудит
- **Роли:** Owner (всё), Admin (контент/импорт/проверки), Editor (контент без критических операций).
- **Безопасность:** строгий CSP; sandbox для iframe; валидация входных данных; rate‑limit на импорт/проверки; защита от XSS/CSRF.
- **Аудит‑лог:** кто/когда: запускал импорт, добавлял демо, менял статусы, удалял.

---

## Аналитика и мониторинг
- **События (frontend):** `catalog_view`, `filter_change`, `search_submit`, `demo_open`, `viewer_open`, `lead_submit`.
- **Ошибки:** Sentry (web/api/jobs).
- **Очереди:** Bull Board (активные/завершённые/ретраи, длительность, тайм‑ауты).
- **Отчёты в админке:** по импортам (сколько найдено/новых/ошибок) и проверкам (сколько active/draft/deleted).

---

## Тестирование: критерии и кейсы
**Unit:**
- Нормализация URL → корректный `url_canonical`.
- Правила статусов: active → (фейл) → draft → (30 дней без успехов) → deleted.

**Integration:**
- Импорт DIFF: фиктивный список URL → таблица «чего нет у нас» корректна.
- Bulk‑добавление демо → появляются в каталоге с нужными полями.

**E2E (админ):**
- Завести Vendor → Сканировать → Выбрать DIFF → Добавить → Проверить в каталоге.
- Имитировать недоступность URL → статус draft; симулировать «+30 дней» → deleted.

**Accessibility:**
- Навигация клавиатурой, фокус‑кольца, aria‑атрибуты, контраст.

---

## CI/CD и окружения
- **Staging/Prod** с одинаковыми сервисами (web/api/db/redis/(meilisearch)/(s3 proxy)).
- **Пайплайн:** линт/тесты/миграции → сборка → деплой на staging → ручной promote в production.
- **Секреты:** менеджер секретов; никаких ключей в репозитории.
- **Бэкапы БД:** ежедневные + еженедельные; регламент восстановления.

---

## Дорожная карта (спринты)
**Спринт 1 — Каркас, роли, базовые страницы**
- Монорепо, окружения, логин и RBAC, пустые страницы публичной части.
- **DoD:** вход в админку работает; роли ограничивают доступ; публичные роуты отдаются.

**Спринт 2 — Модель и CRUD**
- Сущности Vendor/Theme/Demo/ImportRun/CheckRun; CRUD в админке.
- **DoD:** можно руками завести данные; индексы и связи настроены.

**Спринт 3 — Импорт и DIFF**
- Коннекторы CSS/API/Sitemap (минимум один рабочий пример); нормализация URL; экран DIFF; массовое добавление.
- **DoD:** из внешнего источника добавляются новые демо, сразу видны в каталоге.

**Спринт 4 — Каталог/PDP/Viewer**
- Фильтры, поиск, сортировки; iframe + fallback; переключатели ширины.
- **DoD:** демо корректно открываются; UX соответствует требованиям.

**Спринт 5 — Checking и статусы**
- Планировщик/очереди; переходы active/draft/deleted; журнал проверок; вкладка Checking.
- **DoD:** draft при первом фейле; удаление после 30 дней без успехов.

**Спринт 6 — Медиа (опц.)**
- Генерация постера/скринов; хранение в CDN; показ в UI.
- **DoD:** карточки с постерами; fallback при недоступности.

**Спринт 7 — SEO/Аналитика/Мониторинг**
- Sitemap, OG, JSON‑LD; события аналитики; Sentry; отчёты.
- **DoD:** метрики в норме; отчёты доступны в админке.

**Спринт 8 — Полировка и релиз**
- Локализация RU/AM/EN; перформанс‑аудит; финальные политики.
- **DoD:** LCP ≤ 2.5 s; доступность пройдена; готово к продакшену.

---

## API (перечень эндпоинтов)
*(Названия и назначение; без кода.)*

**Auth & Users**
- `POST /auth/login` — вход.
- `POST /auth/logout` — выход.
- `GET /users/me` — профиль и роли.
- `GET /users` / `POST /users` / `PATCH /users/:id` — управление пользователями.
- `GET /audit` — аудит‑лог действий.

**Vendors**
- `GET /vendors` — список (фильтры, пагинация).
- `POST /vendors` — создать.
- `GET /vendors/:id` — получить.
- `PATCH /vendors/:id` — обновить (включая connector/limits).
- `DELETE /vendors/:id` — удалить/деактивировать.

**Themes**
- `GET /themes` — список (фильтры по vendor, категориям, тегам).
- `POST /themes` — создать.
- `PATCH /themes/:id` — обновить/привязки.

**Demos**
- `GET /demos` — список (фильтры по vendor/theme/state/q).
- `POST /demos` — создать (ручное добавление).
- `GET /demos/:id` — получить.
- `PATCH /demos/:id` — обновить (state/поля/override интервалов).
- `DELETE /demos/:id` — удалить (мягко/жёстко).
- `POST /demos/bulk` — массовые операции (activate/draft/delete/recheck).

**Import**
- `POST /import/runs` — запустить сканирование для vendor.
- `GET /import/runs` — журнал импортов.
- `GET /import/runs/:id` — детали (статистика, лог).
- `GET /import/diff?vendorId=...` — получить DIFF (Brand/Name/URL).
- `POST /import/confirm` — добавить выбранные позиции из DIFF.

**Checking**
- `GET /checking/settings` / `PATCH /checking/settings` — глобальные интервалы.
- `PATCH /checking/vendors/:id` — override интервала.
- `PATCH /checking/demos/:id` — override интервала.
- `POST /checking/runs` — ручной запуск проверок.
- `GET /checking/runs` — журнал проверок.
- `GET /checking/runs/:id` — детали по демо.

**Media (опц.)**
- `POST /media/render?demoId=...` — запустить генерацию постера/скринов.
- `GET /media/sets?demoId=...` — получить связанные медиа.

**Public (web)**
- `GET /public/catalog` — список демо (фильтры, пагинация).
- `GET /public/demo/:slug` — карточка демо (данные для PDP).
- `GET /public/vendors` / `GET /public/vendors/:slug` — бренды и их демо.

---

## UX‑описание экранов админки
**Вендоры**
- Поля: Название, Базовый домен, Тип коннектора (CSS/API/Sitemap), Параметры (стартовые URL, селекторы/паттерны, заголовки API), Лимиты (параллельность, пауза, user‑agent), Активен.
- Действия: Сохранить, Деактивировать, Экспорт/Импорт конфигурации.

**Импорт**
- Выпадающий список «Вендор», кнопка «Сканировать».
- После скана: таблица DIFF (**Бренд | Название | URL**), чекбоксы, «Выбрать всё», «Добавить на сайт».
- Боковая панель: статистика ImportRun (found/new/ignored/errors), дата/время.

**Демо**
- Таблица: бренд, название, URL, state, first_seen_at, last_seen_at, last_ok_at, first_failed_at.
- Фильтры: бренд, state, период дат; поиск по названию/URL.
- Действия: «В актив», «В черновик», «Удалить навсегда», «Перепроверить» (bulk).

**Checking**
- Глобальные настройки интервала (дни/часы/минуты).
- Override на уровне вендора/демо.
- История проверок: последние N записей (дата, результат, заметка).
- Тумблер «включить/выключить проверки» (для отладки).

**Пользователи/Роли**
- Список пользователей, роли, статус активности.
- Аудит‑лог: кто/когда/что делал (импорт, добавление, удаление, смена статуса).

---

## Нефункциональные требования и SLA
- **Производительность:** LCP ≤ 2.5 s; TTI ≤ 4 s; CLS < 0.1; TBT < 300 ms.
- **Доступность:** WCAG‑ориентированный базовый набор (фокус‑кольца, aria‑лейблы, контраст).
- **Надёжность:** 99.9% доступности публичной части; очереди устойчивы к рестартам.
- **Бэкапы:** RPO ≤ 24 ч; RTO ≤ 4 ч.
- **Безопасность:** CSP, XSS/CSRF защита, rate‑limits, аудит‑лог.

---

## Топология деплоя
- **Сервисы:** web (Next), api (Nest), db (Postgres), redis (BullMQ), (meilisearch), (s3/r2 proxy).
- **Слои:** CDN → web → api → db/redis; фоновые jobs с отдельными воркерами.
- **Секреты:** менеджер секретов; ротация ключей.
- **Сетевые политики:** ограничение внешнего доступа к db/redis; HTTPS везде.

---

## Открытые вопросы и решения
1) **Нужен ли поиск (Meilisearch) на первом релизе?** — *Решение:* опционально; включить во 2–3 спринте.
2) **Генерация медиа обязательна?** — *Решение:* опционально; MVP без медиа, но с поддержкой постеров в будущем.
3) **Soft‑delete vs hard‑delete для `deleted`?** — *Решение:* по умолчанию hard‑delete (как просили); можно сделать флаг для soft‑delete.
4) **Ограничивать глубину импорта?** — *Да*, максимум N страниц/запросов на один запуск, чтобы не перегружать источники.

---

## Шпаргалка для Cursor
- «Создай монорепо (apps/web, apps/api, jobs, packages/ui, packages/types), окружение и скрипты запуска локально и на staging.»
- «Сделай авторизацию и роли Owner/Admin/Editor с разграничением доступа в админке.»
- «Опиши модели Vendor/Theme/Demo/ImportRun/CheckRun/MediaSet, индексы по `url_canonical` и связям.»
- «Реализуй сервис импорта с режимами CSS/API/Sitemap, нормализуй URL и формируй DIFF; сохраняй ImportRun.»
- «Сделай экран ‘Импорт’ с таблицей DIFF (**Бренд | Название | URL**), чекбоксы, массовое добавление.»
- «Реализуй каталог/PDP/Viewer с iframe + fallback‑скрином и переключателями ширины.»
- «Сделай планировщик проверок и правила статусов: active → draft → (30 дней без успехов) → deleted; экран Checking.»
- «(Опц.) Добавь генерацию постеров/скринов и подключи CDN.»
- «Подключи sitemap/OG/JSON‑LD, события аналитики, Sentry и Bull Board; добавь отчёты в админке.»
