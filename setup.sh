#!/bin/bash

# ===========================================
# Neetrino Platform - Setup Script
# ===========================================
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞ –Ω–∞ –Ω–æ–≤–æ–º –∫–æ–º–ø—å—é—Ç–µ—Ä–µ

set -e  # –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ

echo "üöÄ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞ Neetrino Platform..."

# ===========================================
# –ü—Ä–æ–≤–µ—Ä–∫–∞ Node.js –≤–µ—Ä—Å–∏–∏
# ===========================================
echo "üìã –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ—Ä—Å–∏–∏ Node.js..."

if command -v nvm &> /dev/null; then
    echo "‚úÖ NVM –Ω–∞–π–¥–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º –≤–µ—Ä—Å–∏—é –∏–∑ .nvmrc"
    nvm use
else
    echo "‚ö†Ô∏è  NVM –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–≤–µ—Ä—è–µ–º –≤–µ—Ä—Å–∏—é Node.js"
    NODE_VERSION=$(node --version)
    echo "–¢–µ–∫—É—â–∞—è –≤–µ—Ä—Å–∏—è Node.js: $NODE_VERSION"
    
    if [[ "$NODE_VERSION" != "v24."* ]]; then
        echo "‚ùå –¢—Ä–µ–±—É–µ—Ç—Å—è Node.js –≤–µ—Ä—Å–∏–∏ 24.x.x (LTS)"
        echo "–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Node.js 24.x.x –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ NVM"
        exit 1
    fi
fi

# ===========================================
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
# ===========================================
echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ—Ä–Ω–µ–≤—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
echo "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ—Ä–Ω–µ–≤—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
npm install

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
echo "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –¥–ª—è API..."
cd apps/api && npm install && cd ../..

echo "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –¥–ª—è Web..."
cd apps/web && npm install && cd ../..

echo "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –¥–ª—è Types..."
cd packages/types && npm install && cd ../..

echo "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –¥–ª—è UI..."
cd packages/ui && npm install && cd ../..

# ===========================================
# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
# ===========================================
echo "‚öôÔ∏è  –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è..."

if [ ! -f .env ]; then
    if [ -f env.example ]; then
        echo "–°–æ–∑–¥–∞–Ω–∏–µ .env —Ñ–∞–π–ª–∞ –∏–∑ –ø—Ä–∏–º–µ—Ä–∞..."
        cp env.example .env
        echo "‚úÖ –§–∞–π–ª .env —Å–æ–∑–¥–∞–Ω –∏–∑ env.example"
        echo "‚ö†Ô∏è  –ù–µ –∑–∞–±—É–¥—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ .env —Ñ–∞–π–ª–µ!"
    else
        echo "‚ùå –§–∞–π–ª env.example –Ω–µ –Ω–∞–π–¥–µ–Ω"
    fi
else
    echo "‚úÖ –§–∞–π–ª .env —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
fi

# ===========================================
# –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞
# ===========================================
echo "üî® –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞..."

# –°–±–æ—Ä–∫–∞ –ø–∞–∫–µ—Ç–æ–≤
echo "–°–±–æ—Ä–∫–∞ –ø–∞–∫–µ—Ç–æ–≤..."
npm run build

# ===========================================
# –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏
# ===========================================
echo "‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏..."

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –≤—Å–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Å–æ–±–∏—Ä–∞—é—Ç—Å—è
echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ API..."
cd apps/api && npm run build && cd ../..

echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ Web..."
cd apps/web && npm run build && cd ../..

echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ Types..."
cd packages/types && npm run build && cd ../..

echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ UI..."
cd packages/ui && npm run build && cd ../..

# ===========================================
# –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ
# ===========================================
echo ""
echo "üéâ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
echo ""
echo "üìã –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:"
echo "1. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ —Ñ–∞–π–ª–µ .env"
echo "2. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö PostgreSQL"
echo "3. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç: npm run dev"
echo ""
echo "üîó –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:"
echo "  npm run dev     - –ó–∞–ø—É—Å–∫ –≤ —Ä–µ–∂–∏–º–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏"
echo "  npm run build   - –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞"
echo "  npm run lint    - –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞"
echo "  npm run clean   - –û—á–∏—Å—Ç–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞"
echo ""
echo "üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: README.md"
